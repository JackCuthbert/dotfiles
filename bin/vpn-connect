#!/bin/bash
# TODO: This probably sucks

# Check if tunnel is already active
isActive=`ip link show dev tun0 > /dev/null; echo $?`

if [[ $isActive = 0 ]]
then
  currentService=`sudo systemctl --state running | grep openvpn-client | cut -f1 -d'.' | cut -f2 -d'@'`
  echo "tun0 connection is already active! ($currentService)"
  exit 1
else
  # TODO: Silence output for vpn available
  echo "OK"
fi

# Create a list of options
options=( $(sudo find /etc/openvpn/client/ -printf "%f\n" | grep .conf | cut -f1 -d'.' | sort | xargs -0) )

# Prompt to choose one of them
PS3="Choose a region to connect to: "
select opt in "${options[@]}" "Quit" ; do
  if (( REPLY == 1 + ${#options[@]} )) ; then
    exit

  elif (( REPLY > 0 && REPLY <= ${#options[@]} )) ; then
    echo  "Connecting to PIA $opt"
    sudo systemctl start openvpn-client@$opt
    break

  else
    echo "Invalid option. Try another one."
  fi
done


